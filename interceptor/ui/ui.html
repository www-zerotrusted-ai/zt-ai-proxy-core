<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: http: https:; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' http://localhost:* http://0.0.0.0:*; style-src 'self' 'unsafe-inline'; img-src 'self' data: http: https:; connect-src 'self' http://localhost:* http://0.0.0.0:*;"/>
  <title>ZTProxy Console</title>
  <style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:0;background:#0b1320;color:#e6ecf3;display:flex;min-height:100vh;}
header{background:#182943;padding:14px 16px;display:flex;align-items:center;gap:14px;}
header h1{font-size:17px;margin:0;font-weight:600;letter-spacing:.4px;}
aside#nav{width:210px;background:#101b2d;border-right:1px solid #22344f;display:flex;flex-direction:column;}
aside #brand{border-bottom:1px solid #22344f;}
nav a{padding:10px 16px;text-decoration:none;color:#9abbe5;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;border-left:3px solid transparent;}
nav a.active,nav a:hover{background:#16263d;color:#fff;border-left-color:#1f6feb;}
main{flex:1;padding:18px 28px 48px;overflow-y:auto;}
section{background:#142036;border:1px solid #22344f;border-radius:8px;padding:18px;margin-bottom:26px;}
h2{margin:0 0 10px;font-size:16px;color:#81b9ff;font-weight:600;}
label{display:block;margin-top:10px;font-size:13px;}
select,input[type=text]{background:#0f1a2b;color:#e6ecf3;border:1px solid #2a4565;border-radius:4px;padding:6px 8px;font-size:13px;width:240px;}
button{background:#1f6feb;color:#fff;border:0;border-radius:4px;padding:8px 16px;font-size:13px;cursor:pointer;margin-top:14px;font-weight:600;letter-spacing:.3px;}button:hover{background:#2d79f0;}
code,pre{font-family:ui-monospace,Consolas,monospace;font-size:12px;}
table{width:100%;border-collapse:collapse;font-size:12px;}th,td{padding:4px 6px;text-align:left;border-bottom:1px solid #22344f;}th{background:#1d304d;font-weight:600;}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;background:#22344f;margin-left:6px;}
.row{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;}
.note{font-size:12px;opacity:.75;margin-top:6px;line-height:1.4;}
input[type=checkbox]{transform:scale(1.05);margin-right:6px;}
.danger{color:#ff7b72;} .success{color:#4cc38a;} .mono{font-family:ui-monospace,Consolas,monospace;}
.log-box{white-space:pre-wrap;background:#0f1a2b;border:1px solid #22344f;border-radius:6px;padding:10px;max-height:240px;overflow:auto;font-size:11px;}
ul.tight li{margin-bottom:4px;}
footer{padding:24px 0 60px;font-size:12px;opacity:.55;text-align:center;}
.kv{display:grid;grid-template-columns:220px 1fr;gap:4px 12px;font-size:12px;margin-top:6px;}
.kv div.key{text-transform:uppercase;letter-spacing:.5px;opacity:.7;}
  </style>
</head>
<body>
  <aside id="nav">
    <div id="brand">
      <header><img src="https://identity.zerotrusted.ai/img/logo-with-tagline-white.png" alt="ZeroTrusted AI" style="height:44px;object-fit:contain;filter:brightness(0.95);"/></header>
      <h2 style="padding: 14px 16px;color:#fff;">ZT AI Proxy <span class="badge" id="cfgVersion"></span></h2>
    </div>
    <nav>
      <a href="#status" data-target="statusSection" class="active">ðŸ“Š Status</a>
      <a href="#docs" data-target="docsSection">ðŸ“˜ Documentation</a>
      <a href="#config" data-target="configSection">ðŸ›  Configuration</a>
      <a href="#metrics" data-target="metricsSection">ðŸ“ˆ Metrics</a>
      <a href="#logs" data-target="logsSection">ðŸ—’ Log Tail</a>
      <div style="border-top:1px solid #22344f; margin:8px 0"></div>
      <a id="navApiTest" href="/api-test" target="_blank">ðŸ§ª API Testing</a>
      <a id="navBlocklist" href="/blocklist" target="_blank">ðŸ”— Blocklist API</a>
      <a id="navTestPii" href="/test-pii" target="_blank">ðŸ”— Test PII</a>
    <a id="navFeaturesDocs" href="/docs" target="_blank">ðŸ”— Features /docs</a>
    </nav>
  </aside>
  <main>
    <section id="statusSection">
      <h2>Runtime Status</h2>
      <div class="kv" id="statusKv"><div class="key">loading</div><div>...</div></div>
      <div class="note">Auto-refresh every 5 seconds. Shows live counters & config snapshot.</div>
    </section>
    <section id="docsSection">
      <h2>Documentation</h2>
      <p class="note">This UI exposes configuration, metrics and recent log of the running proxy.</p>
      <h3 style='margin:16px 0 8px;font-size:14px;color:#fff'>Endpoints</h3>
      <ul class="tight" style='font-size:12px;'>
        <li><code>/zt-ui</code> â€“ Web console.</li>
        <li><code>/api-test</code> â€“ Interactive API testing UI (Swagger-like).</li>
        <li><code>/config</code> â€“ GET current config; POST updates.</li>
        <li><code>/logs?n=300</code> â€“ Tail last N log lines.</li>
        <li><code>/metrics</code> â€“ Prometheus style counters.</li>
        <li><code>/features</code> â€“ GET parsed black/white with counts.</li>
        <li><code>/refresh-features</code> â€“ POST to force-refresh features.</li>
        <li><code>/safeguard-keywords</code> â€“ GET organizational policy keywords.</li>
        <li><code>/anonymize-keywords</code> â€“ GET anonymization keywords (API only).</li>
        <li><code>/whitelist-request</code> â€“ POST to request domain whitelisting.</li>
        <li><code>/blacklist-request</code> â€“ POST to request domain blacklisting.</li>
      </ul>
      <h3 style='margin:16px 0 8px;font-size:14px;color:#fff'>Lifecycle</h3>
      <ol style='font-size:12px;line-height:1.5;'>
        <li>Request arrives (optionally via explicit proxy absolute-form URL).</li>
        <li>Heuristics classify potential shadow AI usage.</li>
        <li>Decision: block/allow (enforcement mode).</li>
        <li>Event optionally forwarded upstream.</li>
      </ol>
    </section>
    <section id="configSection">
      <h2>Configuration</h2>
      <div class="row">
        <div><label>Filter Mode<select id="filter_mode"><option value="all">All Requests</option><option value="post-only">POST Only</option><option value="post-chat">POST Chat Only</option><option value="post-chat-pii">POST Chat (PII threshold)</option></select></label></div>
        <div><label>Enforcement Mode<select id="enforcement_mode"><option value="auto">Auto</option><option value="observe">Observe (log only)</option><option value="block">Block</option></select></label></div>
        <div><label><input type="checkbox" id="include_request_body"/>Include Request Body</label><div class="note">Disable for privacy; bodies not forwarded.</div></div>
  <div><label><input type="checkbox" id="allow_proceed"/>Allow user to Proceed after PII block</label><div class="note">If enabled, users can proceed once per block decision.</div></div>
        <div><label><input type="checkbox" id="use_remote_blocklist"/>Use Remote Blocklist</label><div class="note">Fetch domains from ZeroTrusted settings; blocks per enforcement.</div></div>
      </div>
      <div class="row">
        <div>
          <label>Features Base URL
            <input type="text" id="features_url" placeholder="https://dev-guardrails.zerotrusted.ai/api/v3/detect-sensitive-keywords-strict" />
          </label>
          <div class="note">Full endpoint URL including path. Overrides env ZT_FEATURES_URL when set.</div>
        </div>
        <div>
          <label>Proxy API Key
            <input type="text" id="proxy_api_key" placeholder="(optional) API key for remote features/blocklist" />
          </label>
          <div class="note">Used for remote blocklist/whitelist fetches at runtime. Stored locally in config.</div>
        </div>
        <div>
          <label>PII Endpoint URL Override
            <input type="text" id="features_pii_url" placeholder="(optional) http://host:port/detect-sensitive-data-lite" />
          </label>
          <div class="note">Overrides base URL + path; if blank, uses base URL. Env: ZT_FEATURES_PII_URL.</div>
        </div>
        <div>
          <label>Features Bearer Token
            <input type="text" id="features_bearer" placeholder="(optional) Bearer token" />
          </label>
          <div class="note">Used for auth when calling features service. Env: ZT_FEATURES_BEARER.</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>PII Threshold
            <input type="number" id="pii_threshold" min="1" step="1" placeholder="3" />
          </label>
          <div class="note">Minimum findings required to block in "POST Chat (PII threshold)" mode. Env override: <code>ZT_PII_THRESHOLD</code>.</div>
        </div>
        <div>
          <label>PII Categories
            <input type="text" id="pii_categories" placeholder="PII,PHI,PCI" />
          </label>
          <div class="note">Comma-separated categories to consider (e.g., PII, PHI, PCI). Env override: <code>ZT_PII_CATEGORIES</code>.</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>
            <input type="checkbox" id="safeguard_enabled" />
            Enable Safeguard Keywords (Policy Enforcement)
          </label>
          <div class="note">Check chat content for organizational policy violations (requires API key/JWT).</div>
        </div>
      </div>
      <div class="row">
        <div>
          <button id="refreshBlocklist">Refresh Remote Blocklist</button>
          <div id="blocklistStatus" class="note">Blocklist: (loading...)</div>
        </div>
        <div>
          <button id="refreshFeatures">Refresh Features</button>
          <div id="featuresStatus" class="note">Features: (loading...)</div>
        </div>
      </div>
      <button id="saveBtn">Save Configuration</button>
      <div id="saveStatus" class="note"></div>
      <div class="note">Last Updated: <span id="lastUpdated">-</span></div>
    </section>
    <section id="metricsSection">
      <h2>Metrics</h2>
      <table><tbody id="metricsBody"><tr><td colspan="2">Loading...</td></tr></tbody></table>
      <div class="note">Refreshed every 5s.</div>
    </section>
    <section id="logsSection">
      <h2>Recent Log (tail)</h2>
      <div class="note">Last 300 lines. Use /logs?n= for different size.</div>
      <div id="logBox" class="log-box">Loading...</div>
      <button id="refreshLog">Refresh Log</button>
    </section>
    <footer>ZeroTrusted Proxy UI Â· <span id="nowTs"></span></footer>
  </main>
  <script>
const navLinks=[...document.querySelectorAll('nav a[data-target]')];
function activate(targetId){
  navLinks.forEach(a=>{a.classList.toggle('active',a.getAttribute('data-target')===targetId);});
  if(location.hash!=='#'+targetId) location.hash=targetId;
  const el=document.getElementById(targetId); if(el){el.scrollIntoView({behavior:'smooth',block:'start'});} }
navLinks.forEach(a=>a.addEventListener('click',e=>{e.preventDefault();activate(a.getAttribute('data-target'));}));

async function loadConfig(){
  const r=await fetch('/config',{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('cfg '+r.status); const j=await r.json();
  const c=j.config||{}; document.getElementById('filter_mode').value=c.filter_mode||'post-chat-pii';
  document.getElementById('enforcement_mode').value=c.enforcement_mode||'block';
  document.getElementById('include_request_body').checked=!!(c.include_request_body===true||c.include_request_body==='true'||c.include_request_body==='1');
  document.getElementById('allow_proceed').checked=!!(c.allow_proceed===true||c.allow_proceed==='true'||c.allow_proceed==='1');
  // Default to enabled if unset; honor explicit false
  document.getElementById('use_remote_blocklist').checked = (c.use_remote_blocklist==null) ? true : !!(c.use_remote_blocklist===true||c.use_remote_blocklist==='true'||c.use_remote_blocklist==='1');
  document.getElementById('safeguard_enabled').checked=!!(c.safeguard_enabled===true||c.safeguard_enabled==='true'||c.safeguard_enabled==='1');
  try{ const thrEl=document.getElementById('pii_threshold'); if (thrEl) thrEl.value=(c.pii_threshold!=null && c.pii_threshold!=='')? c.pii_threshold : ''; const catEl=document.getElementById('pii_categories'); if (catEl) { if (Array.isArray(c.pii_categories)) catEl.value=c.pii_categories.join(','); else if (typeof c.pii_categories === 'string') catEl.value=c.pii_categories; else catEl.value=''; } }catch(e){}
  try{ 
    const f1=document.getElementById('features_url'); 
    if(f1 && document.activeElement !== f1) f1.value=c.features_url||''; 
    const f2=document.getElementById('features_pii_url'); 
    if(f2 && document.activeElement !== f2) f2.value=c.features_pii_url||''; 
    const fb=document.getElementById('features_bearer'); 
    if(fb && document.activeElement !== fb) fb.value=c.features_bearer||''; 
  }catch(e){}
  try{ const pak=document.getElementById('proxy_api_key'); if(pak && document.activeElement !== pak) pak.value=c.proxy_api_key||''; }catch(e){}
  document.getElementById('lastUpdated').textContent=j.last_updated||'-';
  document.getElementById('cfgVersion').textContent=c.filter_mode+'/'+c.enforcement_mode;
  return c;
}
async function saveConfig(){
  const payload={
    filter_mode:document.getElementById('filter_mode').value,
    enforcement_mode:document.getElementById('enforcement_mode').value,
    include_request_body:document.getElementById('include_request_body').checked,
  allow_proceed:document.getElementById('allow_proceed').checked,
    use_remote_blocklist:document.getElementById('use_remote_blocklist').checked,
    safeguard_enabled:document.getElementById('safeguard_enabled').checked,
    pii_threshold:(()=>{ const v=(document.getElementById('pii_threshold')||{}).value; return v===''?null:Number(v); })(),
    pii_categories:(()=>{ const v=(document.getElementById('pii_categories')||{}).value; return v? v.split(/\s*,\s*/).filter(Boolean) : []; })(),
  features_url:(document.getElementById('features_url')||{}).value||null,
  proxy_api_key:(document.getElementById('proxy_api_key')||{}).value||null,
  features_pii_url:(document.getElementById('features_pii_url')||{}).value||null,
  features_bearer:(document.getElementById('features_bearer')||{}).value||null,
  };
  try{
    window.__ZT_SAVING__=true;
    const r=await fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const t=document.getElementById('saveStatus');
    if(r.ok){ let j=null; try{ j=await r.json(); }catch(_){ } t.textContent='Saved âœ“'; t.className='note success'; try{ if(j && j.last_updated){ const lu=document.getElementById('lastUpdated'); if(lu) lu.textContent=j.last_updated; } }catch(_){ } loadConfig(); } else { t.textContent='Save failed '+r.status; t.className='note danger'; }
    setTimeout(()=>{t.textContent='';},3000);
  } finally { window.__ZT_SAVING__=false; }
}
async function loadMetrics(){ try{const r=await fetch('/metrics'); if(!r.ok) throw 0; const txt=await r.text(); const rows=txt.trim().split(/\n+/).filter(Boolean).map(l=>{const [k,v]=l.split(/\s+/);return `<tr><td>${k}</td><td class=mono>${v}</td></tr>`}); document.getElementById('metricsBody').innerHTML=rows.join(''); } catch(e){ document.getElementById('metricsBody').innerHTML='<tr><td colspan=2 class=danger>Metrics unavailable</td></tr>'; } }
async function loadLog(){ try{const r=await fetch('/logs?n=300'); const txt=await r.text(); document.getElementById('logBox').textContent=txt;}catch(e){document.getElementById('logBox').textContent='Log load failed';} }
async function loadStatus(){ try{const cfg=await loadConfig(); const metricsRaw=await fetch('/metrics').then(r=>r.text()).catch(()=>null); const statusKv=document.getElementById('statusKv'); const metricObj={}; (metricsRaw||'').trim().split(/\n+/).forEach(l=>{const [k,v]=l.split(/\s+/); if(k&&v) metricObj[k]=v;}); const rows=[]; rows.push(['Filter Mode', cfg.filter_mode||'-']); rows.push(['Enforcement', cfg.enforcement_mode||'-']); rows.push(['Config Path', (cfg && (await (await fetch('/config',{headers:{'Accept':'application/json'}})).json()).config_path) || '(unknown)']); rows.push(['Include Body', (!!(cfg.include_request_body===true||cfg.include_request_body==='true'||cfg.include_request_body==='1'))?'yes':'no']); rows.push(['Remote Blocklist', (!!(cfg.use_remote_blocklist===true||cfg.use_remote_blocklist==='true'||cfg.use_remote_blocklist==='1'))?'enabled':'disabled']); rows.push(['PII Threshold', (cfg.pii_threshold!=null && cfg.pii_threshold!=='')? cfg.pii_threshold : '(default)']); rows.push(['PII Categories', Array.isArray(cfg.pii_categories)? (cfg.pii_categories.join(',')||'(default)') : (cfg.pii_categories||'(default)')]); Object.entries(metricObj).forEach(([k,v])=>rows.push([k,v])); statusKv.innerHTML=rows.map(r=>`<div class=key>${r[0]}</div><div>${r[1]}</div>`).join(''); }catch(e){ document.getElementById('statusKv').innerHTML='<div class=key>Error</div><div>'+e+'</div>'; } }
async function loadBlocklistStatus(){ try{ const r=await fetch('/blocklist',{headers:{'Accept':'application/json'}}); if(!r.ok) throw 0; const j=await r.json(); const enabled=j.enabled?'enabled':'disabled'; const age=(j.age_seconds==null)?'n/a':(j.age_seconds+'s'); const tokenInfo = j.token_present ? '' : ' (no API key)'; const countStr = (j.count==null)?'n/a':String(j.count); document.getElementById('blocklistStatus').textContent=`Blocklist: ${enabled}, ${countStr} domains (age ${age})${tokenInfo}`; }catch(e){document.getElementById('blocklistStatus').textContent='Blocklist: unavailable';} }
async function loadFeaturesStatus(){ try{ const r=await fetch('/features',{headers:{'Accept':'application/json'}}); if(!r.ok) throw 0; const j=await r.json(); const age=(j.age_seconds==null)?'n/a':(j.age_seconds+'s'); document.getElementById('featuresStatus').textContent=`Features: ${j.black_count||0} black, ${j.white_count||0} white (age ${age})`; }catch(e){document.getElementById('featuresStatus').textContent='Features: unavailable';} }
document.getElementById('saveBtn').addEventListener('click',saveConfig);
document.getElementById('refreshLog').addEventListener('click',loadLog);
const refreshBlocklistBtn=document.getElementById('refreshBlocklist');
if(refreshBlocklistBtn){refreshBlocklistBtn.addEventListener('click',async()=>{ refreshBlocklistBtn.disabled=true; refreshBlocklistBtn.textContent='Refreshing...'; try{ const r=await fetch('/blocklist?force=true',{method:'GET',headers:{'Accept':'application/json'}}); const statusEl=document.getElementById('blocklistStatus'); if(r.ok){ try{ const j=await r.json(); if (j && (j.remote || j.black || j.white)){ if ((j.black_count||0)===0 && (j.white_count||0)===0){ statusEl.textContent='Blocklist: 0 domains. Check API key or tenant config.'; statusEl.className='note danger'; } else { statusEl.textContent=`Blocklist refreshed: ${j.black_count||0} black, ${j.white_count||0} white (TTL ${j.ttl_seconds||0}s)`; statusEl.className='note'; } } else { await loadBlocklistStatus(); } }catch(_){ await loadBlocklistStatus(); } } else { let msg='Refresh failed'; try{ const ct=r.headers.get('content-type')||''; if(ct.includes('application/json')){ const j=await r.json(); msg=j.message||j.error||JSON.stringify(j); } else { msg=await r.text(); } }catch(_){ } statusEl.textContent=`Blocklist: ${msg}`; statusEl.className='note danger'; } }finally{ refreshBlocklistBtn.disabled=false; refreshBlocklistBtn.textContent='Refresh Remote Blocklist'; } });}
const refreshFeaturesBtn=document.getElementById('refreshFeatures');
if(refreshFeaturesBtn){refreshFeaturesBtn.addEventListener('click',async()=>{ refreshFeaturesBtn.disabled=true; refreshFeaturesBtn.textContent='Refreshing...'; try{ const r=await fetch('/refresh-features',{method:'POST',headers:{'Content-Type':'application/json'}}); if(r.ok){ try{ const j=await r.json(); const info=`Features refreshed: ${j.black_count||0} black, ${j.white_count||0} white (TTL ${j.ttl_seconds||0}s)`; document.getElementById('featuresStatus').textContent=info; } catch(_){ await loadFeaturesStatus(); } } else { let msg='Refresh failed'; try{ const ct=r.headers.get('content-type')||''; if(ct.includes('application/json')){ const j=await r.json(); msg=j.message||JSON.stringify(j); } else { msg=await r.text(); } }catch(_){ } document.getElementById('featuresStatus').textContent=`Features: ${msg}`; } } finally { refreshFeaturesBtn.disabled=false; refreshFeaturesBtn.textContent='Refresh Features'; } });}
function debounce(fn,ms){let t;return function(){clearTimeout(t);const args=arguments;t=setTimeout(()=>fn.apply(this,args),ms||300);};}
const autoSave=debounce(()=>saveConfig(),350);
['filter_mode','enforcement_mode','include_request_body','allow_proceed','use_remote_blocklist','safeguard_enabled','pii_threshold','pii_categories','features_url','proxy_api_key','features_pii_url','features_bearer'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.addEventListener('input',()=>{autoSave();}); el.addEventListener('change',()=>{autoSave();}); });
loadConfig().catch(()=>{}); loadMetrics(); loadLog(); loadStatus(); loadBlocklistStatus(); loadFeaturesStatus();
setInterval(loadMetrics,5000); setInterval(loadLog,15000); setInterval(()=>{ if(!window.__ZT_SAVING__) loadStatus(); },5000);
setInterval(loadBlocklistStatus,15000); setInterval(loadFeaturesStatus,20000);
setInterval(()=>{const el=document.getElementById('nowTs'); if(el) el.textContent=new Date().toISOString();},1000);
const initial=(location.hash||'#status').replace('#',''); if(document.getElementById(initial+'Section')) activate(initial+'Section');
(function(){ try{ const loc = window.location; const base = loc.protocol + '//' + loc.hostname + ':' + loc.port; const bl = document.getElementById('navBlocklist'); if (bl) bl.href = base + '/blocklist'; const tp = document.getElementById('navTestPii'); if (tp) tp.href = base + '/test-pii'; }catch(e){} })();
  </script>
</body>
</html>
